<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cotizadores CASH4U</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --color-primary: #FF7F00;
            --color-primary-dark: #e65100;
            --color-secondary: #007BFF;
            --color-secondary-dark: #0056b3;
            --color-purple: #6f42c1; 
            --color-purple-dark: #5a32a3;
            --color-bg: #f0f2f5;
            --color-text: #333;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 15px 35px rgba(0,0,0,0.15);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; align-items: center; 
            background-color: var(--color-bg); color: var(--color-text); 
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER ESTILO HERO --- */
        header { 
            width: 100%; 
            background: linear-gradient(135deg, #FF8C00, #FF4500);
            padding: 35px 20px 60px;
            text-align: center; color: white; 
            box-shadow: 0 10px 30px rgba(255, 69, 0, 0.3);
            position: relative; 
            z-index: 10;
            border-bottom-left-radius: 50% 20px;
            border-bottom-right-radius: 50% 20px;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        .header-content { position: relative; z-index: 2; }

        h1 { 
            margin: 0; font-size: 1.8em; letter-spacing: 1px; text-transform: uppercase; font-weight: 800; 
            line-height: 1.1; text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .subtitle {
            margin-top: 5px; font-size: 0.85em; opacity: 0.9; font-weight: 400; letter-spacing: 2px; text-transform: uppercase;
        }
        
        .content { width: 95%; max-width: 1100px; margin: -30px auto 20px; padding: 0; position: relative; z-index: 1; }

        /* --- MEN√ö PRINCIPAL --- */
        .menu-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 5px; }
        
        .menu-card { 
            background: white; border-radius: 15px; overflow: hidden;
            text-align: center; box-shadow: var(--shadow-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease; border: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .menu-card:active { transform: scale(0.98); }
        .menu-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        
        .card-header-accent { height: 6px; width: 100%; }
        .accent-orange { background: linear-gradient(to right, var(--color-primary), #ffd700); }
        .accent-purple { background: linear-gradient(to right, var(--color-purple), #d63384); }
        .accent-dark { background: linear-gradient(to right, #333, #666); }

        .card-body { padding: 25px 20px; }
        
        .menu-card h3 { 
            color: var(--color-text); margin-top: 0; font-size: 1.3em; font-weight: 700; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .card-icon { font-size: 1.5em; }
        .menu-card p { color: #666; line-height: 1.5; font-size: 0.95em; margin-bottom: 20px; }
        
        .btn-menu { 
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); 
            color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; cursor: pointer; 
            font-weight: 700; font-size: 1.05em; box-shadow: var(--shadow-sm); transition: filter 0.2s;
        }
        .btn-menu:hover { filter: brightness(1.1); }
        
        .btn-purple { background: linear-gradient(135deg, var(--color-purple), var(--color-purple-dark)); }
        .btn-dark { background: linear-gradient(135deg, #333, #555); }

        /* --- FORMULARIO --- */
        .form-container { 
            background-color: white; padding: 35px; border-radius: 20px; 
            box-shadow: var(--shadow-lg); display: none; margin: 10px auto; 
            position: relative; border-top: 5px solid var(--color-secondary);
        }
        
        .btn-back { 
            background-color: #eff2f7; color: #555; border: none; padding: 8px 16px; 
            border-radius: 30px; cursor: pointer; margin-bottom: 20px; display: inline-flex; 
            align-items: center; gap: 6px; font-weight: 600; font-size: 0.9em; transition: background 0.2s;
        }
        .btn-back:hover { background-color: #e0e3e9; }
        
        #tituloFormulario { text-align: center; color: var(--color-secondary); font-size: 1.8em; margin: 5px 0; font-weight: 800; }
        #rangoInfo { text-align: center; color: #777; font-style: italic; font-size: 0.9em; margin-bottom: 25px; display: block; background: #f0f8ff; padding: 8px 15px; border-radius: 20px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85em; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select { 
            padding: 14px; font-size: 16px; width: 100%; box-sizing: border-box; 
            border: 2px solid #e1e1e1; border-radius: 12px; background: #fcfcfc; 
            font-family: 'Poppins', sans-serif; appearance: none; transition: border-color 0.2s;
        }
        input:focus, select:focus { 
            border-color: var(--color-secondary); background: #fff; outline: none; 
        }
        
        input[readonly] { background-color: #f2f4f8; color: #666; font-weight: 600; border-color: transparent; cursor: default; }

        .section-title { 
            grid-column: span 2; border-bottom: none; margin-top: 25px; margin-bottom: 10px; 
            padding-bottom: 5px; color: var(--color-secondary); font-weight: 700; font-size: 1.1em;
            position: relative; display: flex; align-items: center; gap: 10px;
        }
        .section-title::before { content: ''; width: 6px; height: 6px; background: var(--color-secondary); border-radius: 50%; display: inline-block; }
        .section-title::after { content: ''; position: absolute; bottom: 0; left: 16px; width: 40px; height: 3px; background: var(--color-secondary); border-radius: 3px; opacity: 0.5; }

        /* Estilos espec√≠ficos para Dual/Single */
        .single-mode-container { grid-column: span 2; }
        .dual-mode-container { grid-column: span 2; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .neto-dual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* √Årea de Neto Destacada */
        .neto-container {
            grid-column: span 2;
            background: linear-gradient(135deg, #e3f2fd, #f1f8ff);
            padding: 25px; border-radius: 15px;
            border-left: 6px solid var(--color-secondary);
            box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column;
        }
        .inp-neto-destacado {
            background: transparent !important; border: none !important; box-shadow: none !important; padding: 5px 0;
            font-size: 2em; color: var(--color-secondary-dark); font-weight: 800;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.5); width: 100%;
        }

        .btn-action { 
            background: linear-gradient(135deg, var(--color-secondary), var(--color-secondary-dark));
            width: 100%; margin-top: 25px; font-size: 1.1em; font-weight: 700; padding: 18px; border: none; color: white; border-radius: 12px; cursor: pointer; 
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3); transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-action:active { transform: translateY(2px); }
        .btn-action:disabled { background: #ccc; box-shadow: none; transform: none; }
        
        .alerta { background-color: #fff5f5; color: #c53030; border-left: 4px solid #c53030; padding: 15px; border-radius: 8px; font-weight: 600; margin-top: 15px; display: none; }
        .plusvalia-style input { color: #28a745; background-color: #f0fff4; border: 2px solid #c6f6d5; font-weight: bold; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 90%; width: 320px; box-shadow: var(--shadow-lg); animation: popIn 0.3s ease-out; }
        .modal-icon { font-size: 50px; margin-bottom: 15px; display: block; }
        .modal-btn { background: linear-gradient(135deg, #28a745, #218838); color: white; border: none; padding: 12px 30px; border-radius: 50px; cursor: pointer; font-size: 16px; margin-top: 15px; font-weight: 700; width: 100%; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- MEDIA QUERIES (M√ìVIL) --- */
        @media (max-width: 768px) {
            header { padding-bottom: 50px; }
            h1 { font-size: 1.4em; }
            .form-container { padding: 20px 15px; }
            .menu-container { grid-template-columns: 1fr; } 
            
            .form-grid, .dual-mode-container, .neto-dual-grid { 
                grid-template-columns: 1fr !important; 
                gap: 15px;
            }
            
            .full-width, .neto-container, .section-title, .single-mode-container, .dual-mode-container { 
                grid-column: span 1; 
            }

            .inp-neto-destacado { font-size: 1.8em; }
            #neto_dual_mode label { font-size: 0.85em; }
            .dual-mode-container > div { margin-bottom: 0; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üí∏ CASH4U <span style="font-weight: 300;">|</span> COTIZADORES</h1>
            <div class="subtitle">Herramientas Financieras Ejecutivas</div>
        </div>
    </header>

    <div class="content">

        <div id="menuPrincipal" class="menu-container">
            <div class="menu-card">
                <div class="card-header-accent accent-orange"></div>
                <div class="card-body">
                    <h3><span class="card-icon">üè†</span> TIPO I</h3>
                    <p>Rango exclusivo:<br><strong>$180,000 - $370,000</strong></p>
                    <p style="font-size: 0.8em; color: #999; background: #f9f9f9; padding: 5px; border-radius: 5px;">*Sin plusval√≠a.</p>
                    <button class="btn-menu" onclick="iniciarCotizador('tipo1')">Ingresar</button>
                </div>
            </div>

            <div class="menu-card">
                <div class="card-header-accent accent-orange"></div>
                <div class="card-body">
                    <h3><span class="card-icon">üìà</span> TIPO II</h3>
                    <p>Rango exclusivo:<br><strong>$325,000 - $1,350,000</strong></p>
                    <p style="font-size: 0.8em; color: #28a745; background: #f0fff4; padding: 5px; border-radius: 5px; font-weight: 600;">*Plusval√≠a: 3% s/Subcuenta</p>
                    <button class="btn-menu" onclick="iniciarCotizador('tipo2')">Ingresar</button>
                </div>
            </div>

            <div class="menu-card">
                <div class="card-header-accent accent-purple"></div>
                <div class="card-body">
                    <h3><span class="card-icon">ü§ù</span> Corresidencial</h3>
                    <p>Rango global:<br><strong>$325,000 - $1,350,000</strong></p>
                    <p style="font-size: 0.8em; color: var(--color-purple); background: #f3e5f5; padding: 5px; border-radius: 5px; font-weight: 600;">*Mancomunado. Plusval√≠a: 3% s/Subcuenta</p>
                    <button class="btn-menu btn-purple" onclick="iniciarCotizador('corresidencial')">Ingresar</button>
                </div>
            </div>

            <div class="menu-card">
                <div class="card-header-accent accent-dark"></div>
                <div class="card-body">
                    <h3><span class="card-icon">üìÑ</span> Unir PDFs</h3>
                    <p>Fusi√≥n de documentos.</p>
                    <button class="btn-menu btn-dark" onclick="unirPDFs()">Ir a Herramienta</button>
                </div>
            </div>
        </div>

        <div id="formularioWeb" class="form-container">
            <button class="btn-back" onclick="regresarMenu()"><span>‚ùÆ</span> Men√∫ Principal</button>

            <h3 id="tituloFormulario">Cotizaci√≥n</h3>
            <span id="rangoInfo"></span>
            
            <div class="form-grid">
                <div class="section-title">1. Informaci√≥n del Cliente</div>
                
                <div class="full-width">
                    <label>Nombre (Titular):</label>
                    <input type="text" id="inp_cliente" placeholder="Ej. JUAN P√âREZ" style="text-transform: uppercase;">
                </div>
                
                <div id="div_cliente2" class="full-width" style="display:none;">
                    <label>Nombre (Co-titular):</label>
                    <input type="text" id="inp_cliente2" placeholder="Ej. MAR√çA LOPEZ" style="text-transform: uppercase;">
                </div>

                <div><label>Fecha de Emisi√≥n:</label><input type="date" id="inp_fecha"></div>

                <div class="section-title">2. Datos Financieros</div>
                
                <div id="input_single_mode" class="single-mode-container">
                    <label style="font-size: 1em; color: var(--color-secondary);">VALOR DE SUBCUENTA ($):</label>
                    <input type="text" inputmode="numeric" id="inp_valor" placeholder="$0.00" 
                           oninput="calcularDesglose()" onblur="formatearInput(this)" onfocus="desformatearInput(this)"
                           style="font-size: 1.2em; font-weight: bold;">
                </div>

                <div id="input_dual_mode" class="dual-mode-container" style="display: none;">
                    <div>
                        <label style="color: var(--color-purple);">SUBCUENTA 1 ($):</label>
                        <input type="text" inputmode="numeric" id="inp_valor1" placeholder="$0.00" 
                               oninput="calcularDesglose()" onblur="formatearInput(this)" onfocus="desformatearInput(this)"
                               style="font-weight: bold; border-color: var(--color-purple);">
                    </div>
                    <div>
                        <label style="color: var(--color-purple);">SUBCUENTA 2 ($):</label>
                        <input type="text" inputmode="numeric" id="inp_valor2" placeholder="$0.00" 
                               oninput="calcularDesglose()" onblur="formatearInput(this)" onfocus="desformatearInput(this)"
                               style="font-weight: bold; border-color: var(--color-purple);">
                    </div>
                    <div class="full-width" style="text-align: right; font-size: 0.9em; color: #666;">
                        Suma Total: <span id="lbl_suma_total" style="font-weight: bold;">$0.00</span>
                    </div>
                </div>

                <div class="full-width">
                    <div id="alertaRango" class="alerta">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size: 1.5em;">‚ö†Ô∏è</span>
                            <div>
                                <strong>MONTO FUERA DE RANGO.</strong><br>
                                <span style="font-weight:normal; font-size:0.9em;">Verifica el tipo de cotizador.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="row_plusvalia" class="plusvalia-style full-width" style="display: none;">
                    <label>+ Plusval√≠a (3%):</label><input type="text" id="inp_plusvalia" readonly>
                </div>
                
                <div><label>- Costos Compra:</label><input type="text" id="inp_costos_compra" readonly></div>
                <div><label>- Costos Venta:</label><input type="text" id="inp_costos_venta" readonly></div>
                <div><label>- Honorarios Base:</label><input type="text" id="inp_honorarios" readonly></div>
                
                <div>
                    <label>Descuento (%):</label>
                    <select id="inp_porcentaje_descuento" onchange="calcularDesglose()">
                        <option value="0">0% (Sin descuento)</option>
                        <option value="5">5% Descuento</option>
                        <option value="10">10% Descuento</option>
                        <option value="15">15% Descuento</option>
                    </select>
                </div>

                <div class="full-width"><label>Info Descuento:</label><input type="text" id="inp_leyenda_descuento" readonly style="font-style: italic; color: #d9534f; background: #fff5f5; border-color: #feb2b2; font-size: 0.9em;"></div>
                
                <div id="neto_single_mode" class="neto-container">
                    <label style="color: var(--color-secondary-dark); font-size: 0.9em;">NETO A RECIBIR (=):</label>
                    <input type="text" id="inp_neto" readonly class="inp-neto-destacado">
                </div>

                <div id="neto_dual_mode" class="neto-container" style="display: none; background: linear-gradient(135deg, #f3e5f5, #fdfbff); border-left-color: var(--color-purple);">
                    <div class="neto-dual-grid">
                        <div>
                            <label style="color: var(--color-purple-dark); font-size: 0.85em;">NETO CLIENTE 1:</label>
                            <input type="text" id="inp_neto1" readonly class="inp-neto-destacado" style="font-size: 1.6em;">
                        </div>
                        <div>
                            <label style="color: var(--color-purple-dark); font-size: 0.85em;">NETO CLIENTE 2:</label>
                            <input type="text" id="inp_neto2" readonly class="inp-neto-destacado" style="font-size: 1.6em;">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px; color: #777; font-size: 0.9em;">
                        Total Neto: <span id="lbl_neto_total_dual" style="font-weight: bold;">$0.00</span>
                    </div>
                </div>

                <div class="section-title">3. Ejecutivo</div>
                <div class="full-width">
                    <label>Ejecutivo:</label>
                    <select id="inp_ejecutivo" onchange="cargarDatosEjecutivo()">
                        <option value="">-- Seleccione --</option>
                    </select>
                </div>
                <div><label>Email:</label><input type="text" id="inp_correo" readonly style="font-size: 0.9em;"></div>
                <div><label>Tel√©fono:</label><input type="text" id="inp_telefono" readonly></div>
            </div>
            
            <button id="btnGenerar" class="btn-action" onclick="generarPDF()">GENERAR PDF ‚ú®</button>
        </div>
    </div>

    <div id="modalExito" class="modal-overlay">
        <div class="modal-box">
            <span class="modal-icon">üéâ</span>
            <h3 style="margin-top:0; color: #28a745;">¬°Listo!</h3>
            <p style="margin-bottom: 15px;">Documento generado.</p>
            <button class="modal-btn" onclick="cerrarModal()">Cerrar</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE RANGOS CORREGIDA ---
        const configuracion = {
            'tipo1': { pdf: 'Tipo 1.pdf', titulo: 'Cotizador TIPO I', min: 180000, max: 370000, isDual: false },
            'tipo2': { pdf: 'Tipo 2.pdf', titulo: 'Cotizador TIPO II', min: 325000, max: 1350000, isDual: false },
            'corresidencial': { pdf: 'Corresidencial.pdf', titulo: 'Cotizador CORRESIDENCIAL', min: 325000, max: 1350000, isDual: true }
        };

        let tipoActual = ""; let pdfUrl = "";
        const divMenu = document.getElementById('menuPrincipal');
        const divForm = document.getElementById('formularioWeb');
        const inputSingle = document.getElementById('input_single_mode');
        const inputDual = document.getElementById('input_dual_mode');
        const netoSingle = document.getElementById('neto_single_mode');
        const netoDual = document.getElementById('neto_dual_mode');
        const rowPlusvalia = document.getElementById('row_plusvalia');
        const divCliente2 = document.getElementById('div_cliente2');
        const alerta = document.getElementById('alertaRango');
        const btnGenerar = document.getElementById('btnGenerar');
        const modal = document.getElementById('modalExito');

        const listaEjecutivos = [
            { nombre: "Ana Catalina Dergal", correo: "katian.d@cash4u.com.mx", tel: "5510099363" },
            { nombre: "Claudia Pinedo Poch", correo: "claudia.p@cash4u.com.mx", tel: "5525614296" },
            { nombre: "Cristina Rond√°n √Ålvarez", correo: "cristina.r@cash4u.com.mx", tel: "5555088136" },
            { nombre: "Gabriela Reyes", correo: "gabriela.r@cash4u.com.mx", tel: "5521096025" },
            { nombre: "Isabel G√≥mez Diez", correo: "isabel.g@cash4u.com.mx", tel: "5575050464" },
            { nombre: "Jimena Romero", correo: "jimena.r@cash4u.com.mx", tel: "5516981746" },
            { nombre: "Jose Berlanga", correo: "jose.b@cash4u.com.mx", tel: "" }, 
            { nombre: "Karla Ibarrola Torres", correo: "karla.i@cash4u.com.mx", tel: "5514745220" },
            { nombre: "Loren Ramos Portilla", correo: "loren.ramos@cash4u.com.mx", tel: "5521368938" },
            { nombre: "Mar√≠a Laura Laisequilla Ceballos", correo: "mlaura.laisequilla@cash4.com.mx", tel: "4427909237" },
            { nombre: "Martha Georgina Garc√≠a D√≠az", correo: "georgina.garcia@cash4u.com.mx", tel: "5522474411" },
            { nombre: "Mauricio Garza Castro", correo: "mauricio.g@cash4u.com.mx", tel: "5543577436" },
            { nombre: "Mercedes Wilson Fernandez", correo: "m.wilson@cash4u.com.mx", tel: "5554368020" },
            { nombre: "Roberto Moreno Castillo", correo: "roberto.moreno@cash4u.com.mx", tel: "5539992770" },
            { nombre: "Sandra Mart√≠nez", correo: "sandra.m@cash4u.com.mx", tel: "5554332704" },
            { nombre: "Sergio Navarro Diaz De La Vega", correo: "sergio.n@cash4u.com.mx", tel: "5548905695" },
            { nombre: "Ver√≥nica Elizabeth G√≥mez Garc√≠a", correo: "veronica.gomez.g@cash4u.com.mx", tel: "4421316342" },
            { nombre: "Omar Charfen", correo: "omar.charfen@cash4u.com.mx", tel: "5566549935" }
        ];

        (function llenarSelectEjecutivos() {
            const select = document.getElementById('inp_ejecutivo');
            listaEjecutivos.forEach(ejec => {
                const option = document.createElement('option');
                option.value = ejec.nombre; option.text = ejec.nombre; select.appendChild(option);
            });
        })();

        function formatearInput(elem) {
            if (!elem.value) return;
            const valorLimpio = parseFloat(elem.value.replace(/[^0-9.]/g, ''));
            if (!isNaN(valorLimpio)) elem.value = formatoDinero(valorLimpio);
        }

        function desformatearInput(elem) {
            if (!elem.value) return;
            elem.value = elem.value.replace(/[^0-9.]/g, '');
        }

        function obtenerValorNumerico(idElemento) {
            const val = document.getElementById(idElemento).value;
            const limpio = val.replace(/[^0-9.]/g, '');
            return parseFloat(limpio) || 0;
        }

        function cargarDatosEjecutivo() {
            const nombre = document.getElementById('inp_ejecutivo').value;
            const ejecutivo = listaEjecutivos.find(e => e.nombre === nombre);
            document.getElementById('inp_correo').value = ejecutivo ? ejecutivo.correo : "";
            document.getElementById('inp_telefono').value = ejecutivo ? ejecutivo.tel : "";
        }

        function iniciarCotizador(tipo) {
            tipoActual = tipo;
            const config = configuracion[tipo];
            divMenu.style.display = 'none';
            divForm.style.display = 'block';
            document.getElementById('tituloFormulario').innerText = config.titulo;
            pdfUrl = config.pdf; 
            const rInfo = document.getElementById('rangoInfo');
            rInfo.innerText = `Rango: ${formatoDinero(config.min)} ‚Äî ${formatoDinero(config.max)}`;

            if (config.isDual) {
                inputSingle.style.display = 'none';
                inputDual.style.display = 'grid';
                netoSingle.style.display = 'none';
                netoDual.style.display = 'block';
                rowPlusvalia.style.display = 'block'; 
                divCliente2.style.display = 'block'; 
            } else {
                inputSingle.style.display = 'block';
                inputDual.style.display = 'none';
                netoSingle.style.display = 'flex';
                netoDual.style.display = 'none';
                divCliente2.style.display = 'none'; 
                if (tipo === 'tipo2') rowPlusvalia.style.display = 'block';
                else rowPlusvalia.style.display = 'none';
            }
            limpiarCampos();
            calcularDesglose();
            window.scrollTo(0, 0);
        }

        function regresarMenu() {
            divForm.style.display = 'none';
            divMenu.style.display = 'grid';
            limpiarCampos();
            window.scrollTo(0, 0);
        }

        function limpiarCampos() {
            document.getElementById('inp_cliente').value = '';
            document.getElementById('inp_cliente2').value = '';
            document.getElementById('inp_valor').value = '';
            document.getElementById('inp_neto').value = '';
            document.getElementById('inp_valor1').value = '';
            document.getElementById('inp_valor2').value = '';
            document.getElementById('inp_neto1').value = '';
            document.getElementById('inp_neto2').value = '';
            document.getElementById('lbl_suma_total').innerText = '$0.00';
            document.getElementById('lbl_neto_total_dual').innerText = '$0.00';
            document.getElementById('inp_porcentaje_descuento').value = '0';
            document.getElementById('inp_plusvalia').value = '';
            document.getElementById('inp_costos_compra').value = '';
            document.getElementById('inp_costos_venta').value = '';
            document.getElementById('inp_honorarios').value = '';
            document.getElementById('inp_fecha').value = new Date().toISOString().split('T')[0];
            alerta.style.display = 'none';
            btnGenerar.disabled = false;
        }

        function calcularDesglose() {
            const config = configuracion[tipoActual];
            let valorTotal = 0; let val1 = 0; let val2 = 0;

            if (config.isDual) {
                val1 = obtenerValorNumerico('inp_valor1');
                val2 = obtenerValorNumerico('inp_valor2');
                valorTotal = val1 + val2;
                document.getElementById('lbl_suma_total').innerText = formatoDinero(valorTotal);
            } else {
                valorTotal = obtenerValorNumerico('inp_valor');
            }

            const porcentajeDecimal = (parseFloat(document.getElementById('inp_porcentaje_descuento').value) || 0) / 100; 

            // Validaci√≥n Rango General
            if (valorTotal > 0 && (valorTotal < config.min || valorTotal > config.max)) {
                alerta.style.display = 'block';
                btnGenerar.disabled = true; 
                if(config.isDual) {
                    document.getElementById('inp_neto1').value = "$0.00";
                    document.getElementById('inp_neto2').value = "$0.00";
                } else {
                    document.getElementById('inp_neto').value = "$0.00";
                }
                return;
            } else {
                alerta.style.display = 'none';
                btnGenerar.disabled = false;
            }

            let costosCompra = 0; let costosVenta = 0; let honorariosBase = 0; let plusvalia = 0;

            // --- L√ìGICA TIPO 1 (Expandida hasta 370,000) ---
            if (tipoActual === 'tipo1') {
                plusvalia = 0;
                if (valorTotal >= 180000 && valorTotal <= 370000) { 
                    costosCompra = 18000; costosVenta = 7250; honorariosBase = 43000; 
                } 
            }
            // --- L√ìGICA TIPO 2 y CORRESIDENCIAL (Desde 325,000) ---
            else if (tipoActual === 'tipo2' || tipoActual === 'corresidencial') {
                if (valorTotal >= 325000) {
                    plusvalia = valorTotal * 0.03;
                    // Se inicia desde 325,000 con la primera tarifa
                    if (valorTotal >= 325000 && valorTotal < 375000) { costosCompra = 36000; costosVenta = 14500; honorariosBase = 50000; }
                    else if (valorTotal >= 375000 && valorTotal < 450000) { costosCompra = 36000; costosVenta = 14500; honorariosBase = 55000; }
                    else if (valorTotal >= 450000 && valorTotal < 500000) { costosCompra = 38000; costosVenta = 17000; honorariosBase = 59000; }
                    else if (valorTotal >= 500000 && valorTotal < 650000) { costosCompra = 38000; costosVenta = 17000; honorariosBase = 70000; }
                    else if (valorTotal >= 650000 && valorTotal < 800000) { costosCompra = 38000; costosVenta = 17000; honorariosBase = 85000; }
                    else if (valorTotal >= 800000 && valorTotal < 950000) { costosCompra = 61000; costosVenta = 17000; honorariosBase = 97000; }
                    else if (valorTotal >= 950000 && valorTotal < 1010000) { costosCompra = 61000; costosVenta = 17000; honorariosBase = 109000; }
                    else if (valorTotal >= 1010000 && valorTotal < 1150000) { costosCompra = 75000; costosVenta = 17000; honorariosBase = 121000; }
                    else if (valorTotal >= 1150000 && valorTotal < 1350000) { costosCompra = 75000; costosVenta = 17000; honorariosBase = 135000; }
                    else if (valorTotal >= 1350000) { costosCompra = 88000; costosVenta = 17000; honorariosBase = 155000; }
                }
            }

            const cantidadDescuento = honorariosBase * porcentajeDecimal;
            const honorariosFinal = honorariosBase - cantidadDescuento;
            const totalEgresos = costosCompra + costosVenta + honorariosFinal;
            let netoGlobal = 0;
            if (valorTotal > 0) netoGlobal = valorTotal - totalEgresos + plusvalia;

            let textoDescuento = "";
            if (porcentajeDecimal > 0) textoDescuento = "Descuento (" + (porcentajeDecimal * 100) + "%): -" + cantidadDescuento.toFixed(2);

            document.getElementById('inp_plusvalia').value = formatoDinero(plusvalia);
            document.getElementById('inp_costos_compra').value = formatoDinero(costosCompra);
            document.getElementById('inp_costos_venta').value = formatoDinero(costosVenta);
            document.getElementById('inp_honorarios').value = formatoDinero(honorariosFinal);
            document.getElementById('inp_leyenda_descuento').value = textoDescuento;

            if (config.isDual) {
                const porcentaje1 = valorTotal > 0 ? (val1 / valorTotal) : 0;
                const porcentaje2 = valorTotal > 0 ? (val2 / valorTotal) : 0;
                const neto1 = netoGlobal * porcentaje1;
                const neto2 = netoGlobal * porcentaje2;

                document.getElementById('inp_neto1').value = formatoDinero(neto1);
                document.getElementById('inp_neto2').value = formatoDinero(neto2);
                document.getElementById('lbl_neto_total_dual').innerText = formatoDinero(netoGlobal);
            } else {
                document.getElementById('inp_neto').value = formatoDinero(netoGlobal);
            }

            divForm.dataset.honorariosFinal = honorariosFinal.toFixed(2);
            divForm.dataset.plusvalia = plusvalia.toFixed(2);
            divForm.dataset.textoDescuento = textoDescuento;
            divForm.dataset.valorTotalPDF = valorTotal;
            divForm.dataset.netoTotalPDF = netoGlobal;
        }

        function formatoDinero(num) { return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(num); }
        function formatearFechaTexto(fechaStr) {
            if (!fechaStr) return "";
            const [anio, mes, dia] = fechaStr.split('-');
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            return `${dia} de ${meses[parseInt(mes) - 1]} ${anio}`;
        }
        
        function cerrarModal() { modal.style.display = 'none'; }
        function unirPDFs() { window.open('https://www.ilovepdf.com/es/unir_pdf', '_blank'); }

        async function generarPDF() {
            const { PDFDocument } = PDFLib; if(!pdfUrl) return;
            const fechaBonita = formatearFechaTexto(document.getElementById('inp_fecha').value);
            const config = configuracion[tipoActual];
            
            let valParaPDF = 0; let netoParaPDF = 0;
            if (config.isDual) {
                valParaPDF = parseFloat(divForm.dataset.valorTotalPDF);
                netoParaPDF = parseFloat(divForm.dataset.netoTotalPDF);
            } else {
                valParaPDF = obtenerValorNumerico('inp_valor');
                netoParaPDF = document.getElementById('inp_neto').value.replace(/[^0-9.-]+/g,""); 
            }

            // --- FORZAR MAY√öSCULAS ---
            const cliente1 = (document.getElementById('inp_cliente').value.trim() || "CLIENTE").toUpperCase();
            const cliente2 = document.getElementById('inp_cliente2').value.trim().toUpperCase();
            
            const safeC1 = cliente1.replace(/[^a-zA-Z0-9√Å√â√ç√ì√ö√ë ]/g, "");
            let nombreArchivo = `Propuesta_${safeC1}.pdf`;
            
            if(config.isDual && cliente2) {
                const safeC2 = cliente2.replace(/[^a-zA-Z0-9√Å√â√ç√ì√ö√ë ]/g, "");
                nombreArchivo = `Propuesta_${safeC1}_y_${safeC2}.pdf`;
            }

            const mapDatos = {
                'Cliente': cliente1,
                'Cliente2': cliente2,
                'Fecha': fechaBonita,
                'Ejecutivo_Nombre': document.getElementById('inp_ejecutivo').value,
                'Correo': document.getElementById('inp_correo').value,
                'Telefono': document.getElementById('inp_telefono').value,
                'valor': formatoDinero(valParaPDF),
                'Plusvalia': formatoDinero(divForm.dataset.plusvalia),
                'CostosCompra': document.getElementById('inp_costos_compra').value,
                'CostosVenta': document.getElementById('inp_costos_venta').value,
                'Honorarios': document.getElementById('inp_honorarios').value, 
                'DescuentoHonorarios': divForm.dataset.textoDescuento,
                'neto': formatoDinero(netoParaPDF)
            };
            
            if(config.isDual) {
                mapDatos['Valor1'] = document.getElementById('inp_valor1').value; 
                mapDatos['Valor2'] = document.getElementById('inp_valor2').value;
                mapDatos['Neto1'] = document.getElementById('inp_neto1').value;
                mapDatos['Neto2'] = document.getElementById('inp_neto2').value;
            }

            try {
                const existingPdfBytes = await fetch(pdfUrl).then(res => res.arrayBuffer());
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();
                for (const [campoPDF, valorWeb] of Object.entries(mapDatos)) { 
                    try { const field = form.getTextField(campoPDF); if(field) field.setText(valorWeb); } catch (e) {} 
                }
                form.flatten(); 
                const pdfBytes = await pdfDoc.save();
                download(pdfBytes, nombreArchivo, "application/pdf");
                modal.style.display = 'flex';
            } catch (error) { console.error(error); alert("Error: Verifica el archivo PDF."); }
        }

        function download(data, filename, type) {
            var file = new Blob([data], {type: type});
            var a = document.createElement("a"), url = URL.createObjectURL(file);
            a.href = url; a.download = filename; document.body.appendChild(a); a.click();
            setTimeout(function() { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 0); 
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cotizadores CASH4U</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES Y RESET --- */
        :root {
            --color-primary: #FF7F00;
            --color-primary-dark: #e65100;
            --color-secondary: #007BFF;
            --color-secondary-dark: #0056b3;
            --color-success: #28a745;
            --color-purple: #6f42c1;
            --color-bg: #f4f6f9;
            --color-text: #333;
            --shadow-card: 0 8px 20px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; padding: 0; 
            display: flex; flex-direction: column; align-items: center; 
            background-color: var(--color-bg); color: var(--color-text); 
            padding-bottom: 100px; /* Espacio para Sticky Bar */
        }

        /* --- HEADER --- */
        header { 
            width: 100%; 
            background: linear-gradient(135deg, #FF8C00, #FF4500);
            padding: 30px 20px 60px;
            text-align: center; color: white; 
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.2);
            position: relative; z-index: 10;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
        }
        
        h1 { 
            margin: 0; font-size: 1.6em; letter-spacing: 1px; text-transform: uppercase; font-weight: 800; 
            line-height: 1.1; text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .subtitle { margin-top: 5px; font-size: 0.8em; opacity: 0.95; font-weight: 400; letter-spacing: 1px; text-transform: uppercase; }
        
        .content { width: 94%; max-width: 1100px; margin: -35px auto 0; position: relative; z-index: 1; }

        /* --- MEN√ö PRINCIPAL --- */
        .menu-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; padding: 10px 5px; 
        }
        
        .menu-card { 
            background: white; border-radius: 15px; overflow: hidden;
            text-align: center; box-shadow: var(--shadow-card);
            transition: transform 0.2s; border: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .menu-card:active { transform: scale(0.98); }

        .card-header-accent { height: 6px; width: 100%; }
        .accent-orange { background: linear-gradient(to right, var(--color-primary), #ffd700); }
        .accent-purple { background: linear-gradient(to right, var(--color-purple), #d63384); }
        .accent-dark { background: linear-gradient(to right, #333, #666); }

        .card-body { padding: 25px 20px; display: flex; flex-direction: column; height: 100%; }
        .menu-card h3 { margin: 0 0 10px 0; font-size: 1.4em; font-weight: 700; color: #333; }
        
        .range-text { margin-bottom: 15px; line-height: 1.4; color: #555; font-size: 0.9em; }
        .range-amount { font-size: 1.1em; font-weight: 700; color: #333; display: block; margin-top: 5px; }
        .info-pill { font-size: 0.8em; padding: 6px 10px; border-radius: 6px; margin-bottom: 20px; display: block; }
        .pill-gray { background: #f9f9f9; color: #888; }
        .pill-green { background: #f0fff4; color: #28a745; font-weight: 600; }
        .pill-purple { background: #f3e5f5; color: var(--color-purple); font-weight: 600; }

        .btn-menu-wrapper { padding: 0 20px 25px; margin-top: auto; }
        .btn-menu { 
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); 
            color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; cursor: pointer; 
            font-weight: 700; font-size: 1em; box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .btn-menu:active { transform: scale(0.98); }
        .btn-dark { background: linear-gradient(135deg, #333, #555); }

        /* --- FORMULARIO --- */
        .form-container { 
            background-color: white; padding: 25px; border-radius: 20px; 
            box-shadow: var(--shadow-card); display: none; margin-top: 10px; 
            position: relative; border-top: 5px solid var(--color-secondary);
        }
        
        .header-form { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .btn-back { 
            background: #eff2f7; color: #555; border: none; padding: 8px 14px; 
            border-radius: 30px; cursor: pointer; font-weight: 600; font-size: 0.85em; 
            display: inline-flex; align-items: center; gap: 5px; 
        }
        
        #tituloFormulario { margin: 0; color: var(--color-secondary); font-size: 1.4em; font-weight: 800; }
        #rangoInfo { display: block; font-size: 0.8em; color: #777; font-style: italic; width: 100%; text-align: right; }

        /* --- GRID SYSTEM (DESKTOP) --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        .dual-mode-container, .neto-dual-grid { grid-column: span 2; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* --- INPUTS FLOTANTES --- */
        .floating-group { position: relative; margin-bottom: 5px; width: 100%; }
        
        .floating-input, .floating-select {
            width: 100%; padding: 24px 15px 8px 15px; /* M√°s padding arriba para evitar choque */
            font-size: 16px; font-weight: 600; color: #333;
            border: 2px solid #eef0f2; border-radius: 12px; 
            background: #fcfcfc; transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif; height: 58px; /* Altura fija segura */
            appearance: none;
        }
        
        .floating-label {
            position: absolute; left: 15px; top: 18px;
            color: #888; font-size: 14px; font-weight: 500; pointer-events: none;
            transition: 0.2s ease all; text-transform: uppercase; letter-spacing: 0.5px;
            background-color: transparent;
        }

        .floating-input:focus, .floating-select:focus { border-color: var(--color-secondary); background: #fff; }
        
        .floating-input:focus ~ .floating-label,
        .floating-input:not(:placeholder-shown) ~ .floating-label,
        .floating-select:focus ~ .floating-label,
        .floating-select:valid ~ .floating-label {
            top: 6px; font-size: 10px; color: var(--color-secondary); font-weight: 700;
        }

        .floating-input.valid-range { border-color: var(--color-success); background-color: #fafffc; }
        .floating-input[readonly] { background-color: #f8f9fa; color: #666; border-color: transparent; }

        /* --- EJECUTIVO --- */
        .verify-row { grid-column: span 2; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .verify-input-wrapper { flex-grow: 1; position: relative; }
        .action-icons { display: flex; gap: 8px; align-items: center; }
        .icon-check { color: var(--color-success); background: #e6fffa; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; font-size: 0.9em; }
        .icon-check.visible { opacity: 1; }
        .btn-edit { background: #f0f2f5; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1em; }

        /* --- NETOS --- */
        .neto-container {
            grid-column: span 2; background: #eff6ff; border-radius: 16px; padding: 15px;
            border: 1px solid #dbeafe; display: flex; flex-direction: column; align-items: center;
        }
        .neto-label { font-size: 0.85em; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .neto-display { font-size: 2em; font-weight: 800; color: var(--color-secondary); text-shadow: 0 2px 0 rgba(255,255,255,0.8); }

        /* --- STICKY BAR --- */
        .sticky-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(10px);
            color: white; padding: 15px 20px; z-index: 100;
            display: none; justify-content: space-between; align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            border-top-left-radius: 15px; border-top-right-radius: 15px;
        }

        .section-title { 
            grid-column: span 2; margin: 25px 0 10px; color: var(--color-secondary); 
            font-weight: 700; font-size: 1.1em; display: flex; align-items: center; gap: 8px;
        }
        .section-title::before { content: ''; width: 6px; height: 6px; background: currentColor; border-radius: 50%; }

        .alerta { background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 10px; font-weight: 600; display: none; margin-top: 10px; border: 1px solid #fca5a5; font-size: 0.9em; }

        .btn-action { 
            width: 100%; margin-top: 25px; padding: 16px; border: none; border-radius: 12px;
            background: linear-gradient(135deg, var(--color-secondary), #0056b3);
            color: white; font-size: 1.1em; font-weight: 700; cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
        }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; text-align: center; max-width: 300px; width: 85%; }
        .modal-btn { background: #28a745; color: white; padding: 10px 25px; border-radius: 50px; border: none; font-weight: bold; margin-top: 15px; width: 100%; }
        
        .fade-in { animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- OPTIMIZACI√ìN M√ìVIL ESTRICTA --- */
        @media (max-width: 768px) {
            /* Header */
            h1 { font-size: 1.4em; }
            .content { margin-top: -25px; width: 95%; }
            
            /* Men√∫: 1 Columna */
            .menu-container { grid-template-columns: 1fr; padding: 0; }
            
            /* Formulario: Layout Flex Vertical (Rompe el Grid para evitar errores) */
            .form-grid { display: flex; flex-direction: column; gap: 15px; }
            .full-width, .neto-container, .section-title, .single-mode-container { width: 100%; margin: 0; }
            
            /* Contenedores Duales en M√≥vil */
            .dual-mode-container, .neto-dual-grid { display: flex; flex-direction: column; gap: 15px; }
            
            /* Ajustes de Texto */
            .neto-display { font-size: 1.8em; }
            .floating-label { font-size: 13px; }
            
            /* Sticky Bar visible */
            .sticky-bar { display: flex; }
            
            /* Bot√≥n Generar m√°s espacio abajo */
            .btn-action { margin-bottom: 20px; }
            
            /* Ajuste Ejecutivo (iconos a la derecha, input ocupa resto) */
            .verify-row { display: flex; width: 100%; align-items: center; }
            .verify-input-wrapper { flex: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>üí∏ CASH4U <span style="font-weight: 300;">|</span> COTIZADORES</h1>
            <div class="subtitle">Herramientas Financieras Ejecutivas</div>
        </div>
    </header>

    <div class="content">
        <div id="menuPrincipal" class="menu-container fade-in">
            <div class="menu-card">
                <div class="card-header-accent accent-orange"></div>
                <div class="card-body">
                    <h3><span class="card-icon">üè†</span> TIPO I</h3>
                    <div class="range-text">Rango exclusivo:<br><span class="range-amount">$180,000 - $370,000</span></div>
                    <div class="info-pill pill-gray">*Sin plusval√≠a.</div>
                </div>
                <div class="btn-menu-wrapper"><button class="btn-menu" onclick="iniciarCotizador('tipo1')">Ingresar</button></div>
            </div>

            <div class="menu-card">
                <div class="card-header-accent accent-orange"></div>
                <div class="card-body">
                    <h3><span class="card-icon">üìà</span> TIPO II</h3>
                    <div class="range-text">Rango exclusivo:<br><span class="range-amount">$325,000 - $1,350,000</span></div>
                    <div class="info-pill pill-green">*Plusval√≠a: 3% s/Subcuenta</div>
                </div>
                <div class="btn-menu-wrapper"><button class="btn-menu" onclick="iniciarCotizador('tipo2')">Ingresar</button></div>
            </div>

            <div class="menu-card">
                <div class="card-header-accent accent-purple"></div>
                <div class="card-body">
                    <h3><span class="card-icon">ü§ù</span> Corresidencial</h3>
                    <div class="range-text">Rango global:<br><span class="range-amount">$325,000 - $1,350,000</span></div>
                    <div class="info-pill pill-purple">*Mancomunado. Plusval√≠a: 3%</div>
                </div>
                <div class="btn-menu-wrapper"><button class="btn-menu" onclick="iniciarCotizador('corresidencial')">Ingresar</button></div>
            </div>

            <div class="menu-card">
                <div class="card-header-accent accent-dark"></div>
                <div class="card-body">
                    <h3><span class="card-icon">üìÑ</span> Unir PDFs</h3>
                    <div class="range-text">Herramienta externa<br>para fusionar documentos.</div>
                </div>
                <div class="btn-menu-wrapper"><button class="btn-menu btn-dark" onclick="unirPDFs()">Ir a Herramienta</button></div>
            </div>
        </div>

        <div id="formularioWeb" class="form-container">
            <div class="header-form">
                <button class="btn-back" onclick="regresarMenu()">‚ùÆ Men√∫</button>
                <div><h3 id="tituloFormulario">Cotizaci√≥n</h3><span id="rangoInfo"></span></div>
            </div>
            
            <div class="form-grid">
                <div class="section-title">1. Datos del Cliente</div>
                <div class="full-width floating-group">
                    <input type="text" id="inp_cliente" class="floating-input" placeholder=" " style="text-transform: uppercase;">
                    <label class="floating-label">Nombre Completo (Titular)</label>
                </div>
                <div id="div_cliente2" class="full-width floating-group" style="display:none;">
                    <input type="text" id="inp_cliente2" class="floating-input" placeholder=" " style="text-transform: uppercase;">
                    <label class="floating-label">Nombre (Co-titular)</label>
                </div>
                <div class="floating-group">
                    <input type="date" id="inp_fecha" class="floating-input" placeholder=" ">
                    <label class="floating-label">Fecha</label>
                </div>

                <div class="section-title">2. Financiero</div>
                <div id="input_single_mode" class="single-mode-container floating-group">
                    <input type="text" inputmode="numeric" id="inp_valor" class="floating-input" placeholder=" "
                           oninput="calcularDesglose()" onblur="formatearInput(this)" onfocus="desformatearInput(this)">
                    <label class="floating-label">Valor Subcuenta ($)</label>
                </div>
                <div id="input_dual_mode" class="dual-mode-container" style="display: none;">
                    <div class="floating-group">
                        <input type="text" inputmode="numeric" id="inp_valor1" class="floating-input" placeholder=" "
                               oninput="calcularDesglose()" onblur="formatearInput(this)" onfocus="desformatearInput(this)">
                        <label class="floating-label">Subcuenta 1 ($)</label>
                    </div>
                    <div class="floating-group">
                        <input type="text" inputmode="numeric" id="inp_valor2" class="floating-input" placeholder=" "
                               oninput="calcularDesglose()" onblur="formatearInput(this)" onfocus="desformatearInput(this)">
                        <label class="floating-label">Subcuenta 2 ($)</label>
                    </div>
                </div>

                <div class="full-width" id="alertaRango" class="alerta"><div class="alerta">‚ö†Ô∏è Monto fuera de rango.</div></div>

                <div id="row_plusvalia" class="full-width floating-group" style="display: none;">
                    <input type="text" id="inp_plusvalia" class="floating-input" readonly placeholder=" ">
                    <label class="floating-label">Plusval√≠a (3%)</label>
                </div>
                <div class="floating-group"><input type="text" id="inp_costos_compra" class="floating-input" readonly placeholder=" "><label class="floating-label">Costos Compra</label></div>
                <div class="floating-group"><input type="text" id="inp_costos_venta" class="floating-input" readonly placeholder=" "><label class="floating-label">Costos Venta</label></div>
                <div class="floating-group">
                    <select id="inp_porcentaje_descuento" class="floating-select" onchange="calcularDesglose()" required>
                        <option value="0" selected>0%</option><option value="5">5%</option><option value="10">10%</option><option value="15">15%</option>
                    </select>
                    <label class="floating-label">Descuento</label>
                </div>
                <div class="floating-group"><input type="text" id="inp_honorarios" class="floating-input" readonly placeholder=" "><label class="floating-label">Honorarios Base</label></div>
                <div class="full-width floating-group"><input type="text" id="inp_leyenda_descuento" class="floating-input" readonly placeholder=" " style="color: #e11d48; font-style: italic;"><label class="floating-label">Descuento Aplicado</label></div>

                <div id="neto_single_mode" class="neto-container"><span class="neto-label">Neto a Recibir</span><span id="display_neto" class="neto-display">$0.00</span><input type="hidden" id="inp_neto"></div>
                <div id="neto_dual_mode" class="neto-dual-grid" style="display:none;">
                    <div class="neto-container"><span class="neto-label">Neto Cliente 1</span><span id="display_neto1" class="neto-display" style="font-size: 1.5em;">$0.00</span><input type="hidden" id="inp_neto1"></div>
                    <div class="neto-container"><span class="neto-label">Neto Cliente 2</span><span id="display_neto2" class="neto-display" style="font-size: 1.5em;">$0.00</span><input type="hidden" id="inp_neto2"></div>
                </div>

                <div class="section-title">3. Ejecutivo Responsable</div>
                
                <div class="verify-row">
                    <div class="verify-input-wrapper">
                        <select id="inp_ejecutivo" class="floating-select" onchange="cargarDatosEjecutivo()" required><option value="" disabled selected></option></select>
                        <input type="text" id="inp_ejecutivo_manual" class="floating-input" style="display:none;" placeholder=" " oninput="checkManualName()">
                        <label class="floating-label">Nombre Ejecutivo</label>
                    </div>
                    <div class="action-icons"><div id="check_nombre" class="icon-check">‚úì</div><button class="btn-edit" onclick="toggleEditName()">‚úèÔ∏è</button></div>
                </div>
                <div class="verify-row">
                    <div class="verify-input-wrapper"><input type="text" id="inp_correo" class="floating-input" readonly placeholder=" "><label class="floating-label">Correo</label></div>
                    <div class="action-icons"><div id="check_correo" class="icon-check">‚úì</div><button class="btn-edit" onclick="enableField('inp_correo', 'check_correo')">‚úèÔ∏è</button></div>
                </div>
                <div class="verify-row">
                    <div class="verify-input-wrapper"><input type="text" id="inp_telefono" class="floating-input" readonly placeholder=" "><label class="floating-label">Tel√©fono</label></div>
                    <div class="action-icons"><div id="check_telefono" class="icon-check">‚úì</div><button class="btn-edit" onclick="enableField('inp_telefono', 'check_telefono')">‚úèÔ∏è</button></div>
                </div>

                <button id="btnGenerar" class="btn-action" onclick="generarPDF()">GENERAR PDF ‚ú®</button>
            </div>
        </div>
    </div>

    <div id="stickyBar" class="sticky-bar"><div class="sticky-label">Total a Recibir:</div><div id="sticky_value" style="font-weight:700; font-size: 1.4em; color: #4dabf7;">$0.00</div></div>

    <div id="modalExito" class="modal-overlay"><div class="modal-box"><div style="font-size: 40px;">üéâ</div><h3 style="margin: 10px 0; color: #333;">¬°Listo!</h3><p style="color: #666;">Documento generado.</p><button class="modal-btn" onclick="cerrarModal()">Cerrar</button></div></div>

    <script>
        const configuracion = {
            'tipo1': { pdf: 'Tipo 1.pdf', titulo: 'Cotizador TIPO I', min: 180000, max: 370000, isDual: false },
            'tipo2': { pdf: 'Tipo 2.pdf', titulo: 'Cotizador TIPO II', min: 325000, max: 1350000, isDual: false },
            'corresidencial': { pdf: 'Corresidencial.pdf', titulo: 'Cotizador CORRESIDENCIAL', min: 325000, max: 1350000, isDual: true }
        };

        let tipoActual = ""; let pdfUrl = "";
        let previousValues = { neto: 0, neto1: 0, neto2: 0 };
        let manualNameMode = false;

        const divMenu = document.getElementById('menuPrincipal');
        const divForm = document.getElementById('formularioWeb');
        const stickyBar = document.getElementById('stickyBar');
        const inputSingle = document.getElementById('input_single_mode');
        const inputDual = document.getElementById('input_dual_mode');
        const netoSingle = document.getElementById('neto_single_mode');
        const netoDual = document.getElementById('neto_dual_mode');
        const rowPlusvalia = document.getElementById('row_plusvalia');
        const divCliente2 = document.getElementById('div_cliente2');
        const alerta = document.querySelector('.alerta');
        const btnGenerar = document.getElementById('btnGenerar');
        const modal = document.getElementById('modalExito');

        const listaEjecutivos = [
            { nombre: "Ana Catalina Dergal", correo: "katian.d@cash4u.com.mx", tel: "5510099363" },
            { nombre: "Claudia Pinedo Poch", correo: "claudia.p@cash4u.com.mx", tel: "5525614296" },
            { nombre: "Cristina Rond√°n √Ålvarez", correo: "cristina.r@cash4u.com.mx", tel: "5555088136" },
            { nombre: "Gabriela Reyes", correo: "gabriela.r@cash4u.com.mx", tel: "5521096025" },
            { nombre: "Isabel G√≥mez Diez", correo: "isabel.g@cash4u.com.mx", tel: "5575050464" },
            { nombre: "Jimena Romero", correo: "jimena.r@cash4u.com.mx", tel: "5516981746" },
            { nombre: "Jose Berlanga", correo: "jose.b@cash4u.com.mx", tel: "" }, 
            { nombre: "Karla Ibarrola Torres", correo: "karla.i@cash4u.com.mx", tel: "5514745220" },
            { nombre: "Loren Ramos Portilla", correo: "loren.ramos@cash4u.com.mx", tel: "5521368938" },
            { nombre: "Mar√≠a Laura Laisequilla Ceballos", correo: "mlaura.laisequilla@cash4.com.mx", tel: "4427909237" },
            { nombre: "Martha Georgina Garc√≠a D√≠az", correo: "georgina.garcia@cash4u.com.mx", tel: "5522474411" },
            { nombre: "Mauricio Garza Castro", correo: "mauricio.g@cash4u.com.mx", tel: "5543577436" },
            { nombre: "Mercedes Wilson Fernandez", correo: "m.wilson@cash4u.com.mx", tel: "5554368020" },
            { nombre: "Roberto Moreno Castillo", correo: "roberto.moreno@cash4u.com.mx", tel: "5539992770" },
            { nombre: "Sandra Mart√≠nez", correo: "sandra.m@cash4u.com.mx", tel: "5554332704" },
            { nombre: "Sergio Navarro Diaz De La Vega", correo: "sergio.n@cash4u.com.mx", tel: "5548905695" },
            { nombre: "Ver√≥nica Elizabeth G√≥mez Garc√≠a", correo: "veronica.gomez.g@cash4u.com.mx", tel: "4421316342" },
            { nombre: "Omar Charfen", correo: "omar.charfen@cash4u.com.mx", tel: "5566549935" }
        ];

        (function llenarSelectEjecutivos() {
            const select = document.getElementById('inp_ejecutivo');
            listaEjecutivos.forEach(ejec => {
                const option = document.createElement('option');
                option.value = ejec.nombre; option.text = ejec.nombre; select.appendChild(option);
            });
        })();

        function cargarDatosEjecutivo() {
            if (manualNameMode) return;
            const nombre = document.getElementById('inp_ejecutivo').value;
            const ejecutivo = listaEjecutivos.find(e => e.nombre === nombre);
            if (ejecutivo) {
                document.getElementById('inp_correo').value = ejecutivo.correo;
                document.getElementById('inp_telefono').value = ejecutivo.tel;
                ['inp_correo','inp_telefono'].forEach(id => document.getElementById(id).setAttribute('readonly', true));
                ['check_nombre','check_correo','check_telefono'].forEach(id => document.getElementById(id).classList.add('visible'));
            }
        }

        function toggleEditName() {
            manualNameMode = !manualNameMode;
            const select = document.getElementById('inp_ejecutivo');
            const input = document.getElementById('inp_ejecutivo_manual');
            const check = document.getElementById('check_nombre');
            if (manualNameMode) {
                input.value = select.value; select.style.display = 'none'; input.style.display = 'block'; input.focus(); check.classList.remove('visible');
            } else {
                input.style.display = 'none'; select.style.display = 'block'; select.value = ""; check.classList.remove('visible');
            }
        }

        function enableField(inputId, checkId) {
            const input = document.getElementById(inputId);
            input.removeAttribute('readonly'); input.focus();
            document.getElementById(checkId).classList.remove('visible');
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id); if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerText = formatoDinero(Math.floor(progress * (end - start) + start));
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function formatearInput(elem) {
            if (!elem.value) return;
            const valorLimpio = parseFloat(elem.value.replace(/[^0-9.]/g, ''));
            if (!isNaN(valorLimpio)) elem.value = formatoDinero(valorLimpio);
        }
        function desformatearInput(elem) { if(elem.value) elem.value = elem.value.replace(/[^0-9.]/g, ''); }
        function obtenerValorNumerico(id) { return parseFloat(document.getElementById(id).value.replace(/[^0-9.]/g, '')) || 0; }

        function iniciarCotizador(tipo) {
            tipoActual = tipo; const config = configuracion[tipo];
            divMenu.style.display = 'none'; divForm.style.display = 'block'; divForm.classList.add('fade-in');
            document.getElementById('tituloFormulario').innerText = config.titulo.replace("Cotizador ", "");
            pdfUrl = config.pdf; 
            document.getElementById('rangoInfo').innerText = `Rango: ${formatoDinero(config.min)} ‚Äî ${formatoDinero(config.max)}`;

            const isDual = config.isDual;
            inputSingle.style.display = isDual ? 'none' : 'block';
            inputDual.style.display = isDual ? 'flex' : 'none';
            netoSingle.style.display = isDual ? 'none' : 'flex';
            netoDual.style.display = isDual ? 'flex' : 'none';
            divCliente2.style.display = isDual ? 'block' : 'none';
            rowPlusvalia.style.display = (isDual || tipo === 'tipo2') ? 'block' : 'none';

            limpiarCampos(); calcularDesglose(); window.scrollTo(0,0);
        }

        function regresarMenu() {
            divForm.style.display = 'none'; divMenu.style.display = 'grid'; stickyBar.style.display = 'none';
            limpiarCampos(); window.scrollTo(0,0);
        }

        function limpiarCampos() {
            ['inp_cliente','inp_cliente2','inp_valor','inp_valor1','inp_valor2'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('inp_porcentaje_descuento').value='0';
            document.getElementById('inp_fecha').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('inp_ejecutivo').value = "";
            document.getElementById('inp_ejecutivo').style.display = "block";
            document.getElementById('inp_ejecutivo_manual').style.display = "none";
            manualNameMode = false;
            ['inp_correo','inp_telefono'].forEach(id=>document.getElementById(id).value="");
            document.querySelectorAll('.icon-check').forEach(el => el.classList.remove('visible'));

            previousValues = { neto: 0, neto1: 0, neto2: 0 };
            ['display_neto','display_neto1','display_neto2'].forEach(id=>document.getElementById(id).innerText='$0.00');
            alerta.style.display = 'none'; btnGenerar.disabled = false;
            document.querySelectorAll('.floating-input').forEach(el => el.classList.remove('valid-range'));
        }

        function calcularDesglose() {
            const config = configuracion[tipoActual];
            let valorTotal = 0, val1 = 0, val2 = 0;

            if (config.isDual) {
                val1 = obtenerValorNumerico('inp_valor1'); val2 = obtenerValorNumerico('inp_valor2');
                valorTotal = val1 + val2;
            } else { valorTotal = obtenerValorNumerico('inp_valor'); }

            const pct = (parseFloat(document.getElementById('inp_porcentaje_descuento').value)||0)/100; 
            const isValid = (valorTotal > 0 && valorTotal >= config.min && valorTotal <= config.max);

            // Validacion visual
            if(config.isDual) {
                const in1 = document.getElementById('inp_valor1'); const in2 = document.getElementById('inp_valor2');
                if(isValid) { in1.classList.add('valid-range'); in2.classList.add('valid-range'); } 
                else { in1.classList.remove('valid-range'); in2.classList.remove('valid-range'); }
            } else {
                const inS = document.getElementById('inp_valor');
                if(isValid) inS.classList.add('valid-range'); else inS.classList.remove('valid-range');
            }

            if (!isValid && valorTotal > 0) {
                alerta.style.display = 'block'; btnGenerar.disabled = true;
                animateValue("display_neto", previousValues.neto, 0, 300); previousValues.neto=0;
                document.getElementById('sticky_value').innerText="$0.00";
                return;
            } else { alerta.style.display = 'none'; btnGenerar.disabled = false; }

            let cCompra = 0, cVenta = 0, hBase = 0, plusvalia = 0;

            if (tipoActual === 'tipo1') {
                if (valorTotal >= 180000 && valorTotal <= 370000) { cCompra = 18000; cVenta = 7250; hBase = 43000; }
            } else {
                if (valorTotal >= 325000) {
                    plusvalia = valorTotal * 0.03;
                    if (valorTotal < 375000) { cCompra=36000; cVenta=14500; hBase=50000; }
                    else if (valorTotal < 450000) { cCompra=36000; cVenta=14500; hBase=55000; }
                    else if (valorTotal < 500000) { cCompra=38000; cVenta=17000; hBase=59000; }
                    else if (valorTotal < 650000) { cCompra=38000; cVenta=17000; hBase=70000; }
                    else if (valorTotal < 800000) { cCompra=38000; cVenta=17000; hBase=85000; }
                    else if (valorTotal < 950000) { cCompra=61000; cVenta=17000; hBase=97000; }
                    else if (valorTotal < 1010000) { cCompra=61000; cVenta=17000; hBase=109000; }
                    else if (valorTotal < 1150000) { cCompra=75000; cVenta=17000; hBase=121000; }
                    else if (valorTotal < 1350000) { cCompra=75000; cVenta=17000; hBase=135000; }
                    else { cCompra=88000; cVenta=17000; hBase=155000; }
                }
            }

            const hFinal = hBase - (hBase * pct);
            const netoGlobal = Math.max(0, valorTotal - (cCompra + cVenta + hFinal) + plusvalia);

            document.getElementById('inp_plusvalia').value = formatoDinero(plusvalia);
            document.getElementById('inp_costos_compra').value = formatoDinero(cCompra);
            document.getElementById('inp_costos_venta').value = formatoDinero(cVenta);
            document.getElementById('inp_honorarios').value = formatoDinero(hFinal);
            document.getElementById('inp_leyenda_descuento').value = pct > 0 ? `Descuento -${formatoDinero(hBase*pct)}` : "";

            if (config.isDual) {
                const n1 = Math.floor(netoGlobal * (valorTotal>0 ? val1/valorTotal : 0));
                const n2 = Math.floor(netoGlobal * (valorTotal>0 ? val2/valorTotal : 0));
                animateValue("display_neto1", previousValues.neto1, n1, 500);
                animateValue("display_neto2", previousValues.neto2, n2, 500);
                previousValues.neto1 = n1; previousValues.neto2 = n2;
                document.getElementById('inp_neto1').value = formatoDinero(n1);
                document.getElementById('inp_neto2').value = formatoDinero(n2);
                document.getElementById('sticky_value').innerText = formatoDinero(netoGlobal);
            } else {
                animateValue("display_neto", previousValues.neto, Math.floor(netoGlobal), 500);
                previousValues.neto = Math.floor(netoGlobal);
                document.getElementById('inp_neto').value = formatoDinero(netoGlobal);
                document.getElementById('sticky_value').innerText = formatoDinero(netoGlobal);
            }

            divForm.dataset.honorariosFinal = hFinal.toFixed(2);
            divForm.dataset.plusvalia = plusvalia.toFixed(2);
            divForm.dataset.textoDescuento = pct > 0 ? `Descuento -${formatoDinero(hBase*pct)}` : "";
            divForm.dataset.valorTotalPDF = valorTotal;
            divForm.dataset.netoTotalPDF = netoGlobal;

            if(netoGlobal > 0 && window.innerWidth <= 768) stickyBar.style.display = 'flex';
        }

        function formatoDinero(num) { return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(num); }
        function formatearFechaTexto(f) { if(!f)return""; const[a,m,d]=f.split('-'); const ms=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"]; return `${d} de ${ms[parseInt(m)-1]} ${a}`; }
        function cerrarModal(){ modal.style.display='none'; }
        function unirPDFs(){ window.open('https://www.ilovepdf.com/es/unir_pdf','_blank'); }

        async function generarPDF() {
            const { PDFDocument } = PDFLib; if(!pdfUrl) return;
            const config = configuracion[tipoActual];
            
            let valP = 0, netoP = 0;
            if(config.isDual) { valP = parseFloat(divForm.dataset.valorTotalPDF); netoP = parseFloat(divForm.dataset.netoTotalPDF); }
            else { valP = obtenerValorNumerico('inp_valor'); netoP = parseFloat(document.getElementById('inp_neto').value.replace(/[^0-9.-]+/g,"")); }

            const c1 = (document.getElementById('inp_cliente').value.trim() || "CLIENTE").toUpperCase();
            const c2 = document.getElementById('inp_cliente2').value.trim().toUpperCase();
            let execName = manualNameMode ? document.getElementById('inp_ejecutivo_manual').value : document.getElementById('inp_ejecutivo').value;

            const map = {
                'Cliente': c1, 'Cliente2': c2,
                'Fecha': formatearFechaTexto(document.getElementById('inp_fecha').value),
                'Ejecutivo_Nombre': execName,
                'Correo': document.getElementById('inp_correo').value,
                'Telefono': document.getElementById('inp_telefono').value,
                'valor': formatoDinero(valP),
                'Plusvalia': formatoDinero(divForm.dataset.plusvalia),
                'CostosCompra': document.getElementById('inp_costos_compra').value,
                'CostosVenta': document.getElementById('inp_costos_venta').value,
                'Honorarios': document.getElementById('inp_honorarios').value,
                'DescuentoHonorarios': divForm.dataset.textoDescuento,
                'neto': formatoDinero(netoP)
            };
            if(config.isDual) {
                map['Valor1']=document.getElementById('inp_valor1').value; map['Valor2']=document.getElementById('inp_valor2').value;
                map['Neto1']=document.getElementById('inp_neto1').value; map['Neto2']=document.getElementById('inp_neto2').value;
            }

            try {
                const existingPdfBytes = await fetch(pdfUrl).then(res => res.arrayBuffer());
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();
                for (const [key, val] of Object.entries(map)) { try { const f = form.getTextField(key); if(f) f.setText(val); } catch (e){} }
                form.flatten();
                const pdfBytes = await pdfDoc.save();
                
                const safeName = c1.replace(/[^a-zA-Z0-9√Å√â√ç√ì√ö√ë ]/g, "");
                const filename = config.isDual && c2 ? `Propuesta_${safeName}_y_${c2.replace(/[^a-zA-Z0-9√Å√â√ç√ì√ö√ë ]/g, "")}.pdf` : `Propuesta_${safeName}.pdf`;
                
                const blob = new Blob([pdfBytes], {type: "application/pdf"});
                const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = filename;
                document.body.appendChild(link); link.click(); setTimeout(()=>document.body.removeChild(link),0);
                modal.style.display='flex';
            } catch (err) { console.error(err); alert("Error al generar PDF."); }
        }
    </script>
</body>
</html>
